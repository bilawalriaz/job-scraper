{% extends "base.html" %}

{% block title %}Search Configurations - Job Scraper{% endblock %}

{% block content %}
<div class="d-flex justify-between align-center" style="margin-bottom: 32px;">
    <div>
        <h1 style="font-size: 2rem; font-weight: 800; letter-spacing: -0.03em;">Search Configurations</h1>
        <p class="text-muted" style="margin-top: 4px;">Manage your automated job search queries</p>
    </div>
    <button class="btn btn-primary"
            hx-get="/htmx/configs/new"
            hx-target="#config-modal-content"
            _="on click add .show to #config-modal">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Add New Search
    </button>
</div>

<div class="card">
    <div id="configs-table" hx-get="/htmx/configs" hx-trigger="load">
        <div class="htmx-indicator" style="text-align: center; padding: 40px;">
            <div class="spinner" style="width: 40px; height: 40px;"></div>
        </div>
    </div>
</div>

<!-- Config Modal -->
<div class="modal" id="config-modal">
    <div class="modal-content">
        <div id="config-modal-content">
            <div class="modal-body text-center">
                <div class="spinner" style="width: 32px; height: 32px; margin: 20px auto;"></div>
            </div>
        </div>
    </div>
</div>

<script>
// Close modal when clicking outside or on escape
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
    }
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.getElementById('config-modal')?.classList.remove('show');
    }
});

// Handle successful form submission - close modal and refresh
document.body.addEventListener('htmx:afterOnLoad', function(e) {
    // Check if the response was successful (200 status)
    if (e.detail.xhr && e.detail.xhr.status === 200) {
        const modal = document.getElementById('config-modal');
        if (modal && modal.classList.contains('show')) {
            // Check if we're submitting a form (not loading the form content)
            const contentType = e.detail.xhr.getResponseHeader('content-type') || '';
            if (!contentType.includes('text/html') || e.detail.target.id !== 'config-modal-content') {
                // If we submitted a form successfully, close the modal and refresh
                if (e.detail.requestConfig && e.detail.requestConfig.verb === 'post') {
                    modal.classList.remove('show');
                    htmx.trigger('#configs-table', 'load');
                }
            }
        }
    }
});
</script>
{% endblock %}
